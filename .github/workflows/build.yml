name: Build Docker images

on:
  push:
    branches: ["main", "feat/2fd"]
  pull_request:
    branches: ["main"]
    types: [ready_for_review, opened, reopened, synchronize]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build-image:
    if: github.event.pull_request.draft == false
    uses: blackfoot-makers/github-actions/.github/workflows/docker.yml@main
    with:
      dockerfile: ./Dockerfile
      context: ./
      image: ${{ github.event.repository.name }}
    secrets:
      GCP_CREDENTIALS_BASE64: ${{ secrets.GCP_CREDENTIALS_BASE64 }}
  build-image-on-prod:
    if: github.event.pull_request.draft == false
    needs: build-image
    uses: blackfoot-makers/github-actions/.github/workflows/docker-prod.yml@feat/deploy-image-on-prod ## change to '@main' when it's merged
    with:
      dockerimage: ${{ github.event.repository.name }}
    secrets:
      GCP_CREDENTIALS_BASE64: ${{ secrets.GCP_CREDENTIALS_BASE64 }}
      GCP_CREDENTIALS_PROD_BASE64: ${{ secrets.GCP_CREDENTIALS_PROD_BASE64 }}
